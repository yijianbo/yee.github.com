
 <!DOCTYPE HTML>
<html >
<head>
  <meta charset="UTF-8">
  
    <title>异步处理窥探 | 易叔好性感</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="yee">
    
    <meta name="description" content="用过微信网页版的人应该都清楚网页登陆的流程，大致描述一下这个过程：

打开网页版登陆链接
页面会显示一个二维码
用微信客户端扫描二维码，让用户确认登陆网页版
如果确认登陆，网页版会自动进入聊天界面。

这个过程的交互方式和一般的WEB应用不太一样，步骤4网页自动跳转，明显是由服务端主动推送了内容给网">
    
    
    
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/pacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/pacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

  <body>
    <header>
      <div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.svg" alt="易叔好性感" title="易叔好性感"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="易叔好性感">易叔好性感</a></h1>
				<h2 class="blog-motto">最快的捷径是坚持</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜單">
			</a></div>
			<nav class="animated">
				<ul>
					
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
					<li>
					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="text" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:yee.gitcafe.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/03/06/异步处理窥探/" title="异步处理窥探" itemprop="url">异步处理窥探</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://yee.gitcafe.io" title="yee">yee</a>
    </p>
  <p class="article-time">
    <time datetime="2014-03-06T13:33:39.000Z" itemprop="datePublished">2014-03-06</time>
    更新日期:<time datetime="2015-04-25T08:20:55.000Z" itemprop="dateModified">2015-04-25</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目錄</strong>
		<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#配置部分"><span class="toc-number">1.</span> <span class="toc-text">配置部分</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#长连接Servlet实现"><span class="toc-number">2.</span> <span class="toc-text">长连接Servlet实现</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#公共Context容器存放类以及提供给扫描后对长连接响应处理的逻辑"><span class="toc-number">3.</span> <span class="toc-text">公共Context容器存放类以及提供给扫描后对长连接响应处理的逻辑</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#扫描事件触发长连接响应的逻辑"><span class="toc-number">4.</span> <span class="toc-text">扫描事件触发长连接响应的逻辑</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-_多点操作，单点的响应往往依赖于其他点的触发，最典型的就是微信扫描登录了。这个基本的编码思路应该是这样的："><span class="toc-number">4.0.1.</span> <span class="toc-text">1. 多点操作，单点的响应往往依赖于其他点的触发，最典型的就是微信扫描登录了。这个基本的编码思路应该是这样的：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-_单点操作，但是操作往往非常耗时，不能及时响应。这种场景一般会把耗时操作全部抽离到Callable代码段，响应的触发点就是Callable代码的结束处。"><span class="toc-number">4.0.2.</span> <span class="toc-text">2. 单点操作，但是操作往往非常耗时，不能及时响应。这种场景一般会把耗时操作全部抽离到Callable代码段，响应的触发点就是Callable代码的结束处。</span></a></li></ol></li></ol></li></ol>
		</div>
		
		<p>用过微信网页版的人应该都清楚网页登陆的流程，大致描述一下这个过程：</p>
<ol>
<li>打开网页版登陆<a href="https://wx.qq.com/" target="_blank" rel="external">链接</a></li>
<li>页面会显示一个二维码</li>
<li>用微信客户端扫描二维码，让用户确认登陆网页版</li>
<li>如果确认登陆，网页版会自动进入聊天界面。</li>
</ol>
<p>这个过程的交互方式和一般的WEB应用不太一样，<code>步骤4</code>网页自动跳转，明显是由服务端主动推送了内容给网页端，网页端收到跳转确认后才触发的，这里就引出了今天要讨论的问题：<code>服务端推送技术</code>。服务端推送又称为Comet，服务端异步处理等。很早以前就出现了，但一直没有一个统一的标准，存在着不少Comet技术框架，各个Web容器也各自实现了自己的Comet支持。最近公司的产品也出现了和微信网页版登陆类似的场景，需要用到Comet技术，我简单的研究了下，写下来记录一下。</p>
<p>针对Comet技术的选择性蛮多，我匆匆看了一下，就有这么3个方案：</p>
<ul>
<li><p>Tomcat 内置支持，需要实现CometProcessor接口。但是应用就依赖Tomcat容器了。</p>
</li>
<li><p>Servlet3 天然支持，Servlet3提供一套完整的异步处理API，包括AsyncContext,AsyncLiseter,AsyncEvent. 要求Tomcat7.0++。</p>
</li>
<li><p>SpringMVC3.2 在Servlet3的基础上做了进一步的封装，编码更为简单，提供Callable，WebAsyncTask，DeferredResult三种方式进行异步编程支持，非常方便。</p>
</li>
</ul>
<p>基于Tomcat的CometProcessor依赖性过大，我基本上不予考虑了。因为时间还算充裕，所以我分别针对Servlet3 和SpringMVC3.2 都做了尝试，其实过程都比较简单，关键是要理解场景。我来介绍下我们产品的实际场景吧，我们要实现的一个功能是扫描动态二维码关注微信公众账号。基本流程是这样的：</p>
<ol>
<li>客户端调用服务端接口获取动态二维码以及二维码内容中内置的ID。（这个时候在客户端能看到一个二维码了，等待用户扫描）</li>
<li>客户端马上调用服务端的一个长连接接口，与服务端建立长连接，等待服务端通知。（这个过程是在后台发生的，用户无法感知）</li>
<li>用户拿出微信扫描二维码，就会有一个扫描事件通知到服务端的扫描接口。（这个时候服务端接收到扫描动作，完成自己的业务操作以后，通知长连接接口，用户已经扫描了，可以返回了）。</li>
</ol>
<p>这个流程里面有这么几个地方是需要能解决的：</p>
<ol>
<li>步骤2里面要求客户端—服务端建立长连接，不会立即返回，客户端一直在等待状态。（Servlet3 的API可以支持，需要把Timeout时间设置长一点，一般是60S够了）</li>
<li>步骤3中 扫描接口要通知长连接接口，如何做到？  必须存在一个公共的容器，容器里面存着上下文信息，扫描接口把执行完毕的上下文告知长连接接口就可以了。</li>
</ol>
<p>所以，实现代码如下：</p>
<h1 id="配置部分">配置部分</h1><p>web.xml  启用Servlet3 的命名空间<br><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;web-app xmlns:<span class="variable">xsi=</span><span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="line">    <span class="variable">xmlns=</span><span class="string">"http://java.sun.com/xml/ns/javaee"</span></span><br><span class="line">    xmlns:<span class="variable">web=</span><span class="string">"http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"</span></span><br><span class="line">    xsi:<span class="variable">schemaLocation=</span><span class="string">"http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"</span></span><br><span class="line">    <span class="variable">id=</span><span class="string">"WebApp_ID"</span> <span class="variable">version=</span><span class="string">"3.0"</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;/web-app&gt;</span><br></pre></td></tr></table></figure></p>
<p>长连接Servlet要开启异步支持：<br><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@WebServlet(<span class="variable">value =</span> <span class="string">"/scan/*"</span>,<span class="variable">asyncSupported =</span> <span class="constant">true</span>)</span><br></pre></td></tr></table></figure></p>
<p>Tomcat server.xml要开启NIO模式<br><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;Connector <span class="variable">port=</span><span class="string">"8080"</span> <span class="variable">protocol=</span><span class="string">"org.apache.coyote.http11.Http11NioProtocol"</span></span><br><span class="line">     <span class="variable">connectionTimeout=</span><span class="string">"20000"</span> <span class="variable">asyncTimeout=</span><span class="string">"150000"</span>  <span class="variable">URIEncoding=</span><span class="string">"utf-8"</span>  <span class="variable">redirectPort=</span><span class="string">"8443"</span> /&gt;</span><br></pre></td></tr></table></figure></p>
<h1 id="长连接Servlet实现">长连接Servlet实现</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@WebServlet</span>(value = <span class="string">"/scan/*"</span>,asyncSupported = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ScanServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// private ScanRetain retain;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger logger = Logger.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ScanRetain.MAP.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        doPost(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        logger.debug(<span class="string">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;开始访问长连接Servlet....."</span>);</span><br><span class="line">        String pathInfo = req.getPathInfo();</span><br><span class="line">        String key = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (pathInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> i = pathInfo.lastIndexOf(<span class="string">'/'</span>);</span><br><span class="line">            <span class="keyword">if</span> (i &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                key = pathInfo.substring(i + <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (key == <span class="keyword">null</span>) &#123;</span><br><span class="line">            PrintWriter writer = resp.getWriter();</span><br><span class="line">            writer.write(<span class="string">"error:not found scan key"</span>);</span><br><span class="line">            writer.flush();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        req.startAsync(req, resp);</span><br><span class="line">        <span class="keyword">if</span> (req.isAsyncStarted()) &#123;</span><br><span class="line">            <span class="keyword">final</span> AsyncContext asyncContext = req.getAsyncContext();</span><br><span class="line">            <span class="keyword">final</span> String theKey = key;</span><br><span class="line">            asyncContext.setTimeout(<span class="number">60</span> * <span class="number">1000L</span>);</span><br><span class="line"></span><br><span class="line">            asyncContext.addListener(<span class="keyword">new</span> AsyncListener() &#123;</span><br><span class="line">                <span class="annotation">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">(AsyncEvent asyncEvent)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                    ScanRetain.MAP.remove(theKey);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="annotation">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTimeout</span><span class="params">(AsyncEvent asyncEvent)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                    ScanRetain.MAP.remove(theKey);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="annotation">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(AsyncEvent asyncEvent)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                    ScanRetain.MAP.remove(theKey);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="annotation">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStartAsync</span><span class="params">(AsyncEvent asyncEvent)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            logger.debug(<span class="string">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;将长连接上下文对象加入队列等待处理........."</span>);</span><br><span class="line">            ScanRetain.MAP.put(theKey, asyncContext);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="公共Context容器存放类以及提供给扫描后对长连接响应处理的逻辑">公共Context容器存放类以及提供给扫描后对长连接响应处理的逻辑</h1><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> class ScanRetain &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 公共上下文容器</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentHashMap&lt;<span class="keyword">String</span>, AsyncContext&gt; MAP = <span class="keyword">new</span> ConcurrentHashMap&lt;<span class="keyword">String</span>, AsyncContext&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger logger = Logger.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> doReturn(<span class="keyword">String</span> <span class="variable">key</span>)&#123;</span><br><span class="line">        logger.debug(<span class="string">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;长连接正在响应....."</span>);</span><br><span class="line">        AsyncContext asyncContext = MAP.<span class="built_in">get</span>(<span class="variable">key</span>);</span><br><span class="line">        <span class="keyword">if</span> (asyncContext == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        HttpServletResponse res = (HttpServletResponse) asyncContext.getResponse();</span><br><span class="line">        DBObject data = <span class="keyword">new</span> BasicDBObject(<span class="string">"result"</span>,<span class="number">1</span>)</span><br><span class="line">                .<span class="built_in">append</span>(<span class="string">"info"</span>,<span class="string">"ok"</span>)</span><br><span class="line">                .<span class="built_in">append</span>(<span class="string">"now"</span>,System.currentTimeMillis());</span><br><span class="line">        <span class="keyword">String</span> <span class="built_in">str</span> = JSON.serialize(data);</span><br><span class="line">        OutputStream os = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            os = res.getOutputStream();</span><br><span class="line">            os.write(<span class="built_in">str</span>.getBytes(<span class="string">"utf-8"</span>));</span><br><span class="line">            logger.debug(<span class="string">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;长连接响应完毕....."</span>);</span><br><span class="line">            os.flush();</span><br><span class="line">            asyncContext.setTimeout(<span class="number">100</span>L);<span class="comment">// 一定要加这一句才会及时返回</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="扫描事件触发长连接响应的逻辑">扫描事件触发长连接响应的逻辑</h1><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Long</span> senceId = <span class="number">0</span>L;</span><br><span class="line"><span class="keyword">if</span> (qrSenceId != <span class="keyword">null</span>) &#123;</span><br><span class="line">    senceId = <span class="keyword">Long</span>.parseLong(qrSenceId);</span><br><span class="line">&#125;</span><br><span class="line">scanRetain.doReturn(senceId + <span class="string">""</span>);</span><br></pre></td></tr></table></figure>
<p>SpringMVC3.2 的实现我也尝试了一下：<br>长连接接口：<br><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// 上下文容器</span><br><span class="line">  public <span class="keyword">static</span> final <span class="type">ConcurrentHashMap</span>&lt;<span class="type">String</span>, <span class="type">DeferredResult</span>&lt;<span class="type">String</span>&gt;&gt; <span class="type">MAP</span> = new <span class="type">ConcurrentHashMap</span>&lt;<span class="type">String</span>, <span class="type">DeferredResult</span>&lt;<span class="type">String</span>&gt;&gt;();</span><br><span class="line"></span><br><span class="line">@<span class="type">RequestMapping</span>(<span class="string">"doScan/&#123;key&#125;"</span>)</span><br><span class="line">    @<span class="type">ResponseBody</span></span><br><span class="line">    public <span class="type">DeferredResult</span>&lt;<span class="type">String</span>&gt; doScan(@<span class="type">PathVariable</span>(<span class="string">"key"</span>) <span class="type">String</span> key) &#123;</span><br><span class="line">        <span class="type">DeferredResult</span>&lt;<span class="type">String</span>&gt; <span class="literal">result</span> = new <span class="type">DeferredResult</span>&lt;<span class="type">String</span>&gt;();</span><br><span class="line">        <span class="type">MAP</span>.put(key, <span class="literal">result</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">result</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>通知长连接响应客户端的测试代码：<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(value<span class="subst">=</span><span class="string">"/newScan/&#123;key&#125;"</span>,produces <span class="subst">=</span> <span class="string">"text/plain;charset=utf-8;"</span>)</span><br><span class="line">    @ResponseBody</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">String</span> newScan(@PathVariable(<span class="string">"key"</span>) <span class="built_in">String</span> key,</span><br><span class="line">            HttpServletRequest req, HttpServletResponse res) &#123;</span><br><span class="line">        DeferredResult<span class="subst">&lt;</span><span class="built_in">String</span><span class="subst">&gt;</span> <span class="built_in">data</span> <span class="subst">=</span> Scans<span class="built_in">.</span><span class="built_in">MAP</span><span class="built_in">.</span>get(key);</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">data</span><span class="subst">!=</span><span class="built_in">null</span>)&#123;</span><br><span class="line">            <span class="built_in">data</span><span class="built_in">.</span>setResult(<span class="string">"this is result:"</span><span class="subst">+</span>System<span class="built_in">.</span>currentTimeMillis());</span><br><span class="line">            Scans<span class="built_in">.</span><span class="built_in">MAP</span><span class="built_in">.</span>remove(key);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"new scan test finished :"</span><span class="subst">+</span>key<span class="subst">+</span><span class="string">"now is :"</span><span class="subst">+</span>System<span class="built_in">.</span>currentTimeMillis();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>Spring的代码实现简单很多，但是也不那么直观，不利于理解。</p>
<p>同时，它还提供另外两种异步处理的方式，只是不适于这个场景，这里也罗列一下。<br>Callable：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@ResponseBody</span></span><br><span class="line">   <span class="annotation">@RequestMapping</span>(<span class="string">"call"</span>)</span><br><span class="line">   <span class="function"><span class="keyword">public</span> Callable&lt;String&gt; <span class="title">call</span><span class="params">(HttpServletRequest req, HttpServletResponse res)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Callable&lt;String&gt;() &#123;</span><br><span class="line">           <span class="annotation">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">               TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">               <span class="keyword">return</span> <span class="string">"hello,callable"</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>WebAsyncTask:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@ResponseBody</span></span><br><span class="line">   <span class="annotation">@RequestMapping</span>(<span class="string">"async"</span>)</span><br><span class="line">   <span class="function"><span class="keyword">public</span> WebAsyncTask&lt;String&gt; <span class="title">async</span><span class="params">(HttpServletRequest req, HttpServletResponse res)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       Callable&lt;String&gt; callable = <span class="keyword">new</span> Callable&lt;String&gt;() &#123;</span><br><span class="line">           <span class="annotation">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">               TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">               <span class="keyword">return</span> <span class="string">"hello,WebAsyncTask"</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> WebAsyncTask&lt;String&gt;(<span class="number">1000</span>*<span class="number">60L</span>,callable);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>上面两种方式也是用于异步操作的，它们比较适用于一些比较耗时的操作（如大数据计算，文件处理），它们的响应一般不存在其他的触发点，就是取决于Callable内部代码块的执行结束。</p>
<p>综上，我们大致可以总结出异步处理的两种应用场景：</p>
<h3 id="1-_多点操作，单点的响应往往依赖于其他点的触发，最典型的就是微信扫描登录了。这个基本的编码思路应该是这样的：">1. 多点操作，单点的响应往往依赖于其他点的触发，最典型的就是微信扫描登录了。这个基本的编码思路应该是这样的：</h3><ul>
<li><p>定义一个上下文存储容器，容器要支持并发，最好选用Concurrent类型。</p>
</li>
<li><p>开发长连接接口，客户端请求连接后，将上下文加入存储容器。</p>
</li>
<li><p>开发响应的触发逻辑代码段。</p>
</li>
<li><p>触发业务完成以后，调用响应触发逻辑。</p>
</li>
</ul>
<h3 id="2-_单点操作，但是操作往往非常耗时，不能及时响应。这种场景一般会把耗时操作全部抽离到Callable代码段，响应的触发点就是Callable代码的结束处。">2. 单点操作，但是操作往往非常耗时，不能及时响应。这种场景一般会把耗时操作全部抽离到Callable代码段，响应的触发点就是Callable代码的结束处。</h3>  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/Servlet3/">Servlet3</a><a href="/tags/异步/">异步</a>
  </div>


<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/java-core/">java-core</a>
</div>



<div class="article-share" id="share">

  <div data-url="http://yee.gitcafe.io/2014/03/06/异步处理窥探/" data-title="异步处理窥探 | 易叔好性感" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2014/03/30/jvm垃圾回收机制探析/" title="jvm垃圾回收机制探析">
  <strong>PREVIOUS:</strong><br/>
  <span>
  jvm垃圾回收机制探析</span>
</a>
</div>


<div class="next">
<a href="/2014/02/23/mysql常见调优/"  title="mysql常见调优">
 <strong>NEXT:</strong><br/> 
 <span>mysql常见调优
</span>
</a>
</div>

</nav>

	
</div>  
      <div class="openaside"><a class="navbutton" href="#" title="顯示側邊欄"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目錄</strong>
  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#配置部分"><span class="toc-number">1.</span> <span class="toc-text">配置部分</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#长连接Servlet实现"><span class="toc-number">2.</span> <span class="toc-text">长连接Servlet实现</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#公共Context容器存放类以及提供给扫描后对长连接响应处理的逻辑"><span class="toc-number">3.</span> <span class="toc-text">公共Context容器存放类以及提供给扫描后对长连接响应处理的逻辑</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#扫描事件触发长连接响应的逻辑"><span class="toc-number">4.</span> <span class="toc-text">扫描事件触发长连接响应的逻辑</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-_多点操作，单点的响应往往依赖于其他点的触发，最典型的就是微信扫描登录了。这个基本的编码思路应该是这样的："><span class="toc-number">4.0.1.</span> <span class="toc-text">1. 多点操作，单点的响应往往依赖于其他点的触发，最典型的就是微信扫描登录了。这个基本的编码思路应该是这样的：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-_单点操作，但是操作往往非常耗时，不能及时响应。这种场景一般会把耗时操作全部抽离到Callable代码段，响应的触发点就是Callable代码的结束处。"><span class="toc-number">4.0.2.</span> <span class="toc-text">2. 单点操作，但是操作往往非常耗时，不能及时响应。这种场景一般会把耗时操作全部抽离到Callable代码段，响应的触发点就是Callable代码的结束处。</span></a></li></ol></li></ol></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隱藏側邊欄"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分類</p>
		<ul>
		
			<li><a href="/categories/Android/" title="Android">Android<sup>8</sup></a></li>
		
			<li><a href="/categories/DB/" title="DB">DB<sup>7</sup></a></li>
		
			<li><a href="/categories/design-pattern/" title="design-pattern">design-pattern<sup>1</sup></a></li>
		
			<li><a href="/categories/java-core/" title="java-core">java-core<sup>9</sup></a></li>
		
			<li><a href="/categories/工具/" title="工具">工具<sup>1</sup></a></li>
		
			<li><a href="/categories/生活/" title="生活">生活<sup>1</sup></a></li>
		
			<li><a href="/categories/读书/" title="读书">读书<sup>1</sup></a></li>
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">標簽</p>
		<ul class="clearfix">
		
			<li><a href="/tags/Android/" title="Android">Android<sup>8</sup></a></li>
		
			<li><a href="/tags/MongoDB/" title="MongoDB">MongoDB<sup>1</sup></a></li>
		
			<li><a href="/tags/NIO/" title="NIO">NIO<sup>1</sup></a></li>
		
			<li><a href="/tags/Servlet3/" title="Servlet3">Servlet3<sup>1</sup></a></li>
		
			<li><a href="/tags/UI/" title="UI">UI<sup>6</sup></a></li>
		
			<li><a href="/tags/design-pattern/" title="design-pattern">design-pattern<sup>1</sup></a></li>
		
			<li><a href="/tags/github/" title="github">github<sup>1</sup></a></li>
		
			<li><a href="/tags/gradle/" title="gradle">gradle<sup>1</sup></a></li>
		
			<li><a href="/tags/hexo/" title="hexo">hexo<sup>1</sup></a></li>
		
			<li><a href="/tags/http/" title="http">http<sup>2</sup></a></li>
		
			<li><a href="/tags/java/" title="java">java<sup>7</sup></a></li>
		
			<li><a href="/tags/java-core/" title="java-core">java-core<sup>2</sup></a></li>
		
			<li><a href="/tags/jvm/" title="jvm">jvm<sup>1</sup></a></li>
		
			<li><a href="/tags/linux/" title="linux">linux<sup>1</sup></a></li>
		
			<li><a href="/tags/mongodb/" title="mongodb">mongodb<sup>4</sup></a></li>
		
			<li><a href="/tags/mysql/" title="mysql">mysql<sup>1</sup></a></li>
		
			<li><a href="/tags/netty/" title="netty">netty<sup>1</sup></a></li>
		
			<li><a href="/tags/nio/" title="nio">nio<sup>1</sup></a></li>
		
			<li><a href="/tags/nosql/" title="nosql">nosql<sup>1</sup></a></li>
		
			<li><a href="/tags/shell/" title="shell">shell<sup>1</sup></a></li>
		
		</ul>
</div>


  <div class="rsspart">
	<a href="null" target="_blank" title="rss">RSS 訂閱</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<div class="social-font clearfix">
		
		
		
		
		
	</div>
		<p class="copyright">Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/A-limon/pacman" target="_blank" title="Pacman">Pacman</a> © 2016 
		
		<a href="http://yee.gitcafe.io" target="_blank" title="yee">yee</a>
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>






  </body>
</html>
