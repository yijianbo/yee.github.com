
 <!DOCTYPE HTML>
<html >
<head>
  <meta charset="UTF-8">
  
    <title>Mongodb复制集 | 易叔好性感</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="yee">
    
    <meta name="description" content="复制机制一直是数据库高可用性设计的重要实现手段。复制机制的优点有：

主从服务器读写分离，降低主服务器的访问压力
备份工作放在从服务器，避免备份操作导致主服务器被锁
当主服务器出现故障，可以快速切换到从服务器，减少宕机时间。

mongodb提供了两种复制机制:

主从复制（官方已不推荐）
复制集
">
    
    
    
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/pacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/pacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

  <body>
    <header>
      <div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.svg" alt="易叔好性感" title="易叔好性感"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="易叔好性感">易叔好性感</a></h1>
				<h2 class="blog-motto">最快的捷径是坚持</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜單">
			</a></div>
			<nav class="animated">
				<ul>
					
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
					<li>
					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="text" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:yee.gitcafe.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/08/09/Mongodb复制集/" title="Mongodb复制集" itemprop="url">Mongodb复制集</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://yee.gitcafe.io" title="yee">yee</a>
    </p>
  <p class="article-time">
    <time datetime="2014-08-09T01:28:00.000Z" itemprop="datePublished">2014-08-09</time>
    更新日期:<time datetime="2015-04-25T08:20:55.000Z" itemprop="dateModified">2015-04-25</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目錄</strong>
		<ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-_准备工作"><span class="toc-number">1.</span> <span class="toc-text">1. 准备工作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-_启动mongod"><span class="toc-number">2.</span> <span class="toc-text">2. 启动mongod</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-_连接到s0，把所有的成员加入"><span class="toc-number">3.</span> <span class="toc-text">3. 连接到s0，把所有的成员加入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-_查看复制集情况"><span class="toc-number">4.</span> <span class="toc-text">4. 查看复制集情况</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1_查看配置，可以了解节点信息"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 查看配置，可以了解节点信息</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2_查看复制集的同步情况"><span class="toc-number">5.</span> <span class="toc-text">4.2 查看复制集的同步情况</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3_当前是否是主节点"><span class="toc-number">6.</span> <span class="toc-text">4.3 当前是否是主节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4_同步日志详情"><span class="toc-number">7.</span> <span class="toc-text">4.4 同步日志详情</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5_测试同步"><span class="toc-number">8.</span> <span class="toc-text">4.5 测试同步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-_正常的运维"><span class="toc-number">9.</span> <span class="toc-text">5. 正常的运维</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1_读写分离"><span class="toc-number">9.1.</span> <span class="toc-text">5.1 读写分离</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2_主从切换"><span class="toc-number">9.2.</span> <span class="toc-text">5.2 主从切换</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3_故障转移"><span class="toc-number">9.3.</span> <span class="toc-text">5.3 故障转移</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4_增减节点"><span class="toc-number">9.4.</span> <span class="toc-text">5.4 增减节点</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-4-1_通过oplog增加节点"><span class="toc-number">9.4.1.</span> <span class="toc-text">5.4.1 通过oplog增加节点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-4-2_通过数据库快照+oplog增加节点"><span class="toc-number">9.4.2.</span> <span class="toc-text">5.4.2 通过数据库快照+oplog增加节点</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-_相关链接"><span class="toc-number">10.</span> <span class="toc-text">6. 相关链接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-_后续"><span class="toc-number">11.</span> <span class="toc-text">7. 后续</span></a></li></ol>
		</div>
		
		<p>复制机制一直是数据库<code>高可用性</code>设计的重要实现手段。复制机制的优点有：</p>
<ul>
<li>主从服务器读写分离，降低主服务器的访问压力</li>
<li>备份工作放在从服务器，避免备份操作导致主服务器被锁</li>
<li>当主服务器出现故障，可以快速切换到从服务器，减少宕机时间。</li>
</ul>
<p>mongodb提供了两种复制机制:</p>
<ul>
<li>主从复制（官方已不推荐）</li>
<li>复制集</li>
</ul>
<p>接下来，我们尝试从无到有建立一个复制集，并参与到建立以后的读写分离，主从切换，故障转移，增减节点等运维工作。</p>
<h3 id="1-_准备工作">1. 准备工作</h3><p>我们在一台机器上建立拥有三个节点的mongodb复制集，它们相应的参数如下：</p>
<table>
<thead>
<tr>
<th style="text-align:center">配置参数</th>
<th style="text-align:center">dbpath</th>
<th style="text-align:center">port</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">server0</td>
<td style="text-align:center">/data/mongo/data/r0</td>
<td style="text-align:center">28010</td>
</tr>
<tr>
<td style="text-align:center">server1</td>
<td style="text-align:center">/data/mongo/data/r1</td>
<td style="text-align:center">28011</td>
</tr>
<tr>
<td style="text-align:center">server2</td>
<td style="text-align:center">/data/mongo/data/r2</td>
<td style="text-align:center">28012</td>
</tr>
</tbody>
</table>
<p>同时，共用参数：</p>
<ul>
<li>logpath: /data/mongo/log/mongo.log</li>
<li>key: /data/mongo/key/key-file</li>
</ul>
<p>这里要做这么几个事情：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. data,log文件夹的创建</span></span><br><span class="line">mkdir -pv <span class="regexp">/data/m</span>ongo<span class="regexp">/data/</span>r0</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="comment">//2. key-file文件，注意权限，不能太OPen</span></span><br><span class="line">openssl rand -base64 <span class="number">741</span> &gt; mongodb-keyfile</span><br><span class="line">chmod <span class="number">600</span> mongodb-keyfile</span><br><span class="line"></span><br><span class="line"><span class="comment">//3. 为了方便，把启动参数全部写到相应的3个配置文件（s0.conf, s1.conf , s2.conf）里面</span></span><br><span class="line"></span><br><span class="line">dbpath = <span class="regexp">/data/m</span>ongo<span class="regexp">/data/</span>r0</span><br><span class="line">port=<span class="number">28010</span></span><br><span class="line">logpath = <span class="regexp">/data/m</span>ongo<span class="regexp">/log/m</span>ongo.log</span><br><span class="line">logappend = <span class="keyword">true</span></span><br><span class="line">fork = <span class="keyword">true</span></span><br><span class="line">rest = <span class="keyword">true</span></span><br><span class="line">replSet=rs0  ##replSet的名字，其他节点要一样</span><br><span class="line">keyFile=<span class="regexp">/data/m</span>ongo<span class="regexp">/key/m</span>ongodb-keyfile</span><br></pre></td></tr></table></figure></p>
<h3 id="2-_启动mongod">2. 启动mongod</h3><p>这里要把三个节点依次启动<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="label">mongod</span> -f /<span class="preprocessor">data</span>/mongo/conf/<span class="literal">s0</span>.conf</span><br><span class="line"><span class="label">mongod</span> -f /<span class="preprocessor">data</span>/mongo/conf/<span class="literal">s1</span>.conf</span><br><span class="line"><span class="label">mongod</span> -f /<span class="preprocessor">data</span>/mongo/conf/<span class="literal">s2</span>.conf</span><br></pre></td></tr></table></figure></p>
<h3 id="3-_连接到s0，把所有的成员加入">3. 连接到s0，把所有的成员加入</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//连接</span></span><br><span class="line">mongo -port <span class="number">28010</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化节点</span></span><br><span class="line">var config_str=&#123;</span><br><span class="line"><span class="label">    _id:</span><span class="string">"rs0"</span>,<span class="string">members:</span>[</span><br><span class="line">        &#123;<span class="string">_id:</span><span class="number">0</span>,<span class="string">host:</span><span class="string">"127.0.0.1:28010"</span>&#125;,</span><br><span class="line">        &#123;<span class="string">_id:</span><span class="number">1</span>,<span class="string">host:</span><span class="string">"127.0.0.1:28011"</span>&#125;,</span><br><span class="line">        &#123;<span class="string">_id:</span><span class="number">2</span>,<span class="string">host:</span><span class="string">"127.0.0.1:28012"</span>&#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;;</span><br><span class="line">rs.initiate(config_str);</span><br></pre></td></tr></table></figure>
<p>到此，复制集应该已经建完了。</p>
<h3 id="4-_查看复制集情况">4. 查看复制集情况</h3><p>复制集的情况查看有这么一些方面</p>
<h4 id="4-1_查看配置，可以了解节点信息">4.1 查看配置，可以了解节点信息</h4><p><code>rs.conf();</code></p>
<p><img src="http://ww4.sinaimg.cn/large/a42ec2f7gw1ej64weibtaj20fk0g2mxr.jpg" alt="Alt text"></p>
<h3 id="4-2_查看复制集的同步情况">4.2 查看复制集的同步情况</h3><p><code>db.printSlaveReplicationInfo();</code><br><img src="http://ww2.sinaimg.cn/large/a42ec2f7gw1ej64xpau7yj20ic07z3zn.jpg" alt="Alt text"></p>
<h3 id="4-3_当前是否是主节点">4.3 当前是否是主节点</h3><p><code>rs.isMaster()</code><br><img src="http://ww1.sinaimg.cn/large/a42ec2f7gw1ej64y8mpshj20hr0ckdgv.jpg" alt="Alt text"></p>
<h3 id="4-4_同步日志详情">4.4 同步日志详情</h3><p><code>db.printReplicationInfo();</code><br><img src="http://ww3.sinaimg.cn/large/a42ec2f7gw1ej64yo3zlaj20ka06faaw.jpg" alt="Alt text"></p>
<p><code>use local;
db.oplog.rs.find();</code><br><img src="http://ww4.sinaimg.cn/large/a42ec2f7gw1ej64z8qutfj20ud0cfjvl.jpg" alt="Alt text"></p>
<h3 id="4-5_测试同步">4.5 测试同步</h3><p>上面的几点都只是看下整体配置情况，现在要测试同步机制是否运转起来了。</p>
<ul>
<li><p>首先在Primary节点中插入一条记录</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">use</span> <span class="tag">my</span>;</span><br><span class="line"><span class="tag">db</span><span class="class">.Temp</span><span class="class">.insert</span>(<span class="rules">&#123;<span class="rule"><span class="attribute">name</span>:<span class="value"><span class="string">"jay"</span>&#125;)</span></span>;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>连接任意一个SECONDARY节点，查看数据</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">mongo</span> <span class="tag">-port</span> 28012;</span><br><span class="line"><span class="tag">use</span> <span class="tag">my</span>;</span><br><span class="line"><span class="tag">db</span><span class="class">.Temp</span><span class="class">.find</span>()<span class="class">.sort</span>(<span class="rules">&#123;<span class="rule"><span class="attribute">_id</span>:<span class="value">-<span class="number">1</span>&#125;).<span class="function">limit</span>(<span class="number">1</span>)</span></span>;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>很有可能，你会得到这个信息：<br><img src="http://ww1.sinaimg.cn/large/a42ec2f7gw1ej64zspp8wj20kj01idg0.jpg" alt="Alt text"></p>
<p> 这是因为SECONDARY节点还没有开启读操作权限，执行下面的命令，然后再查下：<br> <figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">rs</span><span class="class">.slaveOk</span>();</span><br><span class="line"><span class="tag">db</span><span class="class">.Temp</span><span class="class">.find</span>()<span class="class">.sort</span>(<span class="rules">&#123;<span class="rule"><span class="attribute">_id</span>:<span class="value">-<span class="number">1</span>&#125;).<span class="function">limit</span>(<span class="number">1</span>)</span></span>;</span></span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>Sets the slaveOk property for the current connection. Deprecated. Use readPref() and Mongo.setReadPref() to set read preference.<br> <strong>根据官方的说法，sleveOk()已经被废弃了，现在推荐readPref()|Mongo.setReadPref()|db.getMongo().setSlaveOk()来进行读优先设置</strong></p>
</blockquote>
<p> <img src="http://ww2.sinaimg.cn/large/a42ec2f7gw1ej650guf6sj20k502ydg8.jpg" alt="Alt text"><br>数据已经出来了，说明整个复制集是已经正常运转的。</p>
<ul>
<li>可以再回头看看同步记录<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">db</span><span class="class">.oplog</span><span class="class">.rs</span><span class="class">.find</span>()<span class="class">.sort</span>(<span class="rules">&#123;<span class="rule"><span class="attribute">ts</span>:<span class="value">-<span class="number">1</span>&#125;)</span></span>;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><img src="http://ww2.sinaimg.cn/large/a42ec2f7gw1ej651ps6y0j20tx02dq3k.jpg" alt="Alt text"><br>可以看到刚刚的同步记录，op=i 表示插入操作。</p>
<h3 id="5-_正常的运维">5. 正常的运维</h3><p>复制集建立以后，运维过程中经常会遇到的事情有这么几个方面：</p>
<ul>
<li>读写分离</li>
<li>主从切换</li>
<li>故障转移</li>
<li>增减节点</li>
</ul>
<h4 id="5-1_读写分离">5.1 读写分离</h4><p>首先看看复制集设计的初衷：</p>
<blockquote>
<p>A replica set is a group of mongod instances that host the same data set. One mongod, the primary, receives all write operations. All other instances, secondaries, apply operations from the primary so that they have the same data set.</p>
</blockquote>
<p><img src="http://ww1.sinaimg.cn/large/a42ec2f7gw1ej6527ql5bj20dw0bdt97.jpg" alt="Alt text"></p>
<p>所以读写分离基本上是复制集的最主要的目的。通过读写分离，由Primary接收所有的写操作，读操作大部分由Secondary分担，这样数据库的性能将大大提升。</p>
<p>在建立复制集的过程中其实已经遇到了读写分离的问题，需要对Secondary节点进行读操作配置：<br><figure class="highlight openscad"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rs.slaveOk<span class="params">()</span>;<span class="comment">//已废弃</span></span><br><span class="line">db.getMongo<span class="params">()</span>.setSlaveOk<span class="params">()</span></span><br><span class="line">cursor.readPref<span class="params">()</span></span><br><span class="line">db.getMongo.setReadPref<span class="params">()</span></span><br></pre></td></tr></table></figure></p>
<h4 id="5-2_主从切换">5.2 主从切换</h4><p>什么时候需要主从切换？</p>
<blockquote>
<p>当Primary节点负载过大，或者提供了一台性能更好的机器加入复制集，希望把新机器切换为Primary等，实际情况有很多种，主从切换有可能是经常发生的事情。</p>
</blockquote>
<p>主从切换主要有两步</p>
<ul>
<li>冻结不参与切换的Secondary节点</li>
<li>对当期主节点进行降级</li>
</ul>
<p>下来来看看这个过程,当期的Primary是（s1,port 28011）,我希望把（s0,port 28010切换为Primary）<br><strong>step 1</strong><br><figure class="highlight openscad"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对不参与切换的 s2 进行冻结</span></span><br><span class="line">mongo -port <span class="number">28012</span>;</span><br><span class="line">rs.freeze<span class="params">(<span class="number">60</span>)</span>; <span class="comment">// 冻结60秒</span></span><br></pre></td></tr></table></figure></p>
<p><img src="http://ww4.sinaimg.cn/large/a42ec2f7gw1ej652ubt55j209s01mq2u.jpg" alt="Alt text"></p>
<p><strong>step 2</strong><br><figure class="highlight openscad"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//对当前的primary进行降级</span></span><br><span class="line">mongo -port <span class="number">28011</span></span><br><span class="line">rs.stepDown<span class="params">(<span class="number">30</span>)</span>; <span class="comment">// 30秒内完成降级</span></span><br></pre></td></tr></table></figure></p>
<p><img src="./1402970732234.png" alt="Alt text"><br>从图片上看已经降级了</p>
<p><strong>step 3</strong><br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">rs</span><span class="class">.status</span>();</span><br></pre></td></tr></table></figure></p>
<p><img src="http://ww3.sinaimg.cn/large/a42ec2f7gw1ej653brsf9j20re04gt9n.jpg" alt="Alt text"><br>s0已经升级成功</p>
<h4 id="5-3_故障转移">5.3 故障转移</h4><p><code>故障转移</code>是高可用性系统的重要标准。而复制集机制就是<code>故障转移</code>的重要手段，下面来测试一下。</p>
<ul>
<li>首先，查看一下当前正在正常运行的mongod复制集实例。<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ps</span> -ef | <span class="keyword">grep</span> mongod</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><img src="http://ww1.sinaimg.cn/large/a42ec2f7gw1ej653sk35pj20pi0f975y.jpg" alt="Alt text"></p>
<ul>
<li><p>现在我要把primary节点杀掉，看看会出现什么情况</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">kill</span> -<span class="number">9</span> <span class="number">58090</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>连上s1,查看相关当前复制集情况</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mongo -port 28011<span class="comment">;</span></span><br><span class="line">rs.status()<span class="comment">;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><img src="http://ww1.sinaimg.cn/large/a42ec2f7gw1ej654d0m58j20u505vta5.jpg" alt="Alt text"><br><strong>可以看到主节点已经不可用了，但是实际Secondary并没有自动选举出新的Primary，好奇怪，先放这里吧</strong><br><strong>实际情况是：我把s0重启，复制集居然自动选举了，现在s2是Primary</strong></p>
<h4 id="5-4_增减节点">5.4 增减节点</h4><p>增加节点有两种方式：</p>
<ul>
<li>通过oplog增加节点</li>
<li>通过数据库快照和oplog综合增加节点</li>
</ul>
<h5 id="5-4-1_通过oplog增加节点">5.4.1 通过oplog增加节点</h5><p>这个依赖于oplog数据的可靠性，应为oplog是一个CapCollection,数据可能不完整，所以一般不推荐使用。<br>当然这个操作也相对比较简单。<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 启动一个新的待添加的节点</span></span><br><span class="line">mongod -f <span class="regexp">/data/m</span>ongo<span class="regexp">/conf/</span>s3.conf</span><br><span class="line"><span class="comment">// 2. 把这个节点加入</span></span><br><span class="line">rs.add(<span class="string">"127.0.0.1:28013"</span>);</span><br><span class="line"><span class="comment">//3. 静静等待同步结果</span></span><br><span class="line">rs.status();</span><br></pre></td></tr></table></figure></p>
<h5 id="5-4-2_通过数据库快照+oplog增加节点">5.4.2 通过数据库快照+oplog增加节点</h5><p>这个方法比较讨巧，原理就是先复制一份其他Secondary节点的数据库快照文件，然后在Primary加一条数据用于验证。最后把新节点加入复制集，等60秒查看刚刚的数据同步了没有。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1. 复制数据库文件快照</span></span><br><span class="line">cp -rv <span class="regexp">/data/</span>mongo<span class="regexp">/data/</span>s1  <span class="regexp">/data/</span>mongo<span class="regexp">/data/</span>s3</span><br><span class="line"></span><br><span class="line"><span class="comment">//2. 连接primary,新增一条验证数据</span></span><br><span class="line">mongo -port <span class="number">28012</span>;</span><br><span class="line">use my;</span><br><span class="line">my.Temp.insert(&#123;<span class="string">name:</span><span class="string">"test"</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 启动一个待添加的节点</span></span><br><span class="line">mongod -f <span class="regexp">/data/</span>mongo<span class="regexp">/conf/</span>s3.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">//4. 把这个节点加入</span></span><br><span class="line">rs.add(<span class="string">"127.0.0.1:28013"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//5. 静静等待同步结果</span></span><br><span class="line">rs.status();</span><br></pre></td></tr></table></figure>
<p>上面的过程我全程验证了一遍，懒得截图了。</p>
<h3 id="6-_相关链接">6. 相关链接</h3><ul>
<li><a href="http://docs.mongodb.org/manual/core/replication-introduction/" target="_blank" rel="external">官方简单介绍</a></li>
<li><a href="http://docs.mongodb.org/manual/reference/replication/" target="_blank" rel="external">官方 reference</a></li>
<li><a href="http://docs.mongodb.org/ecosystem/drivers/java-replica-set-semantics/" target="_blank" rel="external">java driver to replica</a></li>
<li><a href="http://docs.mongodb.org/ecosystem/drivers/java/" target="_blank" rel="external">java-driver</a></li>
</ul>
<h3 id="7-_后续">7. 后续</h3><p>花了一个下午学习，一个上午写完这篇笔记。其实还有一个很重要的点没有去研究，先记录到这里。</p>
<blockquote>
<p>java driver 与复制集的交互</p>
</blockquote>
  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/mongodb/">mongodb</a>
  </div>


<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/DB/">DB</a>
</div>



<div class="article-share" id="share">

  <div data-url="http://yee.gitcafe.io/2014/08/09/Mongodb复制集/" data-title="Mongodb复制集 | 易叔好性感" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2014/08/09/mongodb分片/" title="mongodb分片">
  <strong>PREVIOUS:</strong><br/>
  <span>
  mongodb分片</span>
</a>
</div>


<div class="next">
<a href="/2014/08/08/同步Or异步，阻塞OR非阻塞/"  title="同步异步阻塞非阻塞的理解">
 <strong>NEXT:</strong><br/> 
 <span>同步异步阻塞非阻塞的理解
</span>
</a>
</div>

</nav>

	
</div>  
      <div class="openaside"><a class="navbutton" href="#" title="顯示側邊欄"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目錄</strong>
  <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-_准备工作"><span class="toc-number">1.</span> <span class="toc-text">1. 准备工作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-_启动mongod"><span class="toc-number">2.</span> <span class="toc-text">2. 启动mongod</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-_连接到s0，把所有的成员加入"><span class="toc-number">3.</span> <span class="toc-text">3. 连接到s0，把所有的成员加入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-_查看复制集情况"><span class="toc-number">4.</span> <span class="toc-text">4. 查看复制集情况</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1_查看配置，可以了解节点信息"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 查看配置，可以了解节点信息</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2_查看复制集的同步情况"><span class="toc-number">5.</span> <span class="toc-text">4.2 查看复制集的同步情况</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3_当前是否是主节点"><span class="toc-number">6.</span> <span class="toc-text">4.3 当前是否是主节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4_同步日志详情"><span class="toc-number">7.</span> <span class="toc-text">4.4 同步日志详情</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5_测试同步"><span class="toc-number">8.</span> <span class="toc-text">4.5 测试同步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-_正常的运维"><span class="toc-number">9.</span> <span class="toc-text">5. 正常的运维</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1_读写分离"><span class="toc-number">9.1.</span> <span class="toc-text">5.1 读写分离</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2_主从切换"><span class="toc-number">9.2.</span> <span class="toc-text">5.2 主从切换</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3_故障转移"><span class="toc-number">9.3.</span> <span class="toc-text">5.3 故障转移</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4_增减节点"><span class="toc-number">9.4.</span> <span class="toc-text">5.4 增减节点</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#5-4-1_通过oplog增加节点"><span class="toc-number">9.4.1.</span> <span class="toc-text">5.4.1 通过oplog增加节点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-4-2_通过数据库快照+oplog增加节点"><span class="toc-number">9.4.2.</span> <span class="toc-text">5.4.2 通过数据库快照+oplog增加节点</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-_相关链接"><span class="toc-number">10.</span> <span class="toc-text">6. 相关链接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-_后续"><span class="toc-number">11.</span> <span class="toc-text">7. 后续</span></a></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隱藏側邊欄"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分類</p>
		<ul>
		
			<li><a href="/categories/Android/" title="Android">Android<sup>8</sup></a></li>
		
			<li><a href="/categories/DB/" title="DB">DB<sup>7</sup></a></li>
		
			<li><a href="/categories/design-pattern/" title="design-pattern">design-pattern<sup>1</sup></a></li>
		
			<li><a href="/categories/java-core/" title="java-core">java-core<sup>9</sup></a></li>
		
			<li><a href="/categories/工具/" title="工具">工具<sup>1</sup></a></li>
		
			<li><a href="/categories/生活/" title="生活">生活<sup>1</sup></a></li>
		
			<li><a href="/categories/读书/" title="读书">读书<sup>1</sup></a></li>
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">標簽</p>
		<ul class="clearfix">
		
			<li><a href="/tags/Android/" title="Android">Android<sup>8</sup></a></li>
		
			<li><a href="/tags/MongoDB/" title="MongoDB">MongoDB<sup>1</sup></a></li>
		
			<li><a href="/tags/NIO/" title="NIO">NIO<sup>1</sup></a></li>
		
			<li><a href="/tags/Servlet3/" title="Servlet3">Servlet3<sup>1</sup></a></li>
		
			<li><a href="/tags/UI/" title="UI">UI<sup>6</sup></a></li>
		
			<li><a href="/tags/design-pattern/" title="design-pattern">design-pattern<sup>1</sup></a></li>
		
			<li><a href="/tags/github/" title="github">github<sup>1</sup></a></li>
		
			<li><a href="/tags/gradle/" title="gradle">gradle<sup>1</sup></a></li>
		
			<li><a href="/tags/hexo/" title="hexo">hexo<sup>1</sup></a></li>
		
			<li><a href="/tags/http/" title="http">http<sup>2</sup></a></li>
		
			<li><a href="/tags/java/" title="java">java<sup>7</sup></a></li>
		
			<li><a href="/tags/java-core/" title="java-core">java-core<sup>2</sup></a></li>
		
			<li><a href="/tags/jvm/" title="jvm">jvm<sup>1</sup></a></li>
		
			<li><a href="/tags/linux/" title="linux">linux<sup>1</sup></a></li>
		
			<li><a href="/tags/mongodb/" title="mongodb">mongodb<sup>4</sup></a></li>
		
			<li><a href="/tags/mysql/" title="mysql">mysql<sup>1</sup></a></li>
		
			<li><a href="/tags/netty/" title="netty">netty<sup>1</sup></a></li>
		
			<li><a href="/tags/nio/" title="nio">nio<sup>1</sup></a></li>
		
			<li><a href="/tags/nosql/" title="nosql">nosql<sup>1</sup></a></li>
		
			<li><a href="/tags/shell/" title="shell">shell<sup>1</sup></a></li>
		
		</ul>
</div>


  <div class="rsspart">
	<a href="null" target="_blank" title="rss">RSS 訂閱</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<div class="social-font clearfix">
		
		
		
		
		
	</div>
		<p class="copyright">Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/A-limon/pacman" target="_blank" title="Pacman">Pacman</a> © 2016 
		
		<a href="http://yee.gitcafe.io" target="_blank" title="yee">yee</a>
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>






  </body>
</html>
