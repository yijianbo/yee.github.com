
 <!DOCTYPE HTML>
<html >
<head>
  <meta charset="UTF-8">
  
    <title>Android异步网络通信解决方案的选择 | 易叔好性感</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="yee">
    
    <meta name="description" content="Android的网络通信处理方式有很多，基于联网操作往往是耗时性的，所以网络通信不可避免的和异步绑定在一起。针对异步网络通信现在也存在不少开源框架，这些我们暂时都不去研究，Android自身其实也提供了不错的机制，只要稍微定制一下就能形成简单优雅的解决方案，这里简单介绍一下现在公司在用的两种处理模式">
    
    
    
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/pacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/pacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

  <body>
    <header>
      <div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.svg" alt="易叔好性感" title="易叔好性感"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="易叔好性感">易叔好性感</a></h1>
				<h2 class="blog-motto">最快的捷径是坚持</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜單">
			</a></div>
			<nav class="animated">
				<ul>
					
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
					<li>
					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="text" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:yee.gitcafe.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2014/08/12/Android异步网络通信解决方案的选择/" title="Android异步网络通信解决方案的选择" itemprop="url">Android异步网络通信解决方案的选择</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://yee.gitcafe.io" title="yee">yee</a>
    </p>
  <p class="article-time">
    <time datetime="2014-08-12T01:21:35.000Z" itemprop="datePublished">2014-08-12</time>
    更新日期:<time datetime="2015-04-25T08:20:55.000Z" itemprop="dateModified">2015-04-25</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目錄</strong>
		<ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#AsyncTask"><span class="toc-number">1.</span> <span class="toc-text">AsyncTask</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Volley"><span class="toc-number">2.</span> <span class="toc-text">Volley</span></a></li></ol>
		</div>
		
		<p>Android的网络通信处理方式有很多，基于联网操作往往是耗时性的，所以网络通信不可避免的和异步绑定在一起。针对异步网络通信现在也存在不少开源框架，这些我们暂时都不去研究，Android自身其实也提供了不错的机制，只要稍微定制一下就能形成简单优雅的解决方案，这里简单介绍一下现在公司在用的两种处理模式。</p>
<ul>
<li>AsyncTask</li>
<li>Volley</li>
</ul>
<h3 id="AsyncTask">AsyncTask</h3><p>在<code>AsyncTask</code>之前，一般涉及到异步处理，只能借助<code>Handler</code>机制来解决。<code>Handler</code>相对来说概念太多，写法比较复杂，现在我们尽量不再使用它。<code>AsyncTask</code>现在依然是我们处理网络连接操作的标准解决方案，它的设计简单，按照<code>处理过程</code>把逻辑进行了拆分组合，非常好用。首先来看一下官网提供的例子：<br><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">// 定义一个<span class="type">Task</span></span><br><span class="line"> private class <span class="type">DownloadFilesTask</span> extends <span class="type">AsyncTask</span>&lt;<span class="type">URL</span>, <span class="type">Integer</span>, <span class="type">Long</span>&gt; &#123;</span><br><span class="line">     protected <span class="type">Long</span> doInBackground(<span class="type">URL</span>... urls) &#123;</span><br><span class="line">         <span class="type">int</span> count = urls.length;</span><br><span class="line">         long totalSize = <span class="number">0</span>;</span><br><span class="line">         <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">             totalSize += <span class="type">Downloader</span>.downloadFile(urls[i]);</span><br><span class="line">             publishProgress((<span class="type">int</span>) ((i / (<span class="type">float</span>) count) * <span class="number">100</span>));</span><br><span class="line">             // <span class="type">Escape</span> early <span class="keyword">if</span> cancel() <span class="keyword">is</span> called</span><br><span class="line">             <span class="keyword">if</span> (isCancelled()) <span class="keyword">break</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> totalSize;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     protected <span class="type">void</span> onProgressUpdate(<span class="type">Integer</span>... progress) &#123;</span><br><span class="line">         setProgressPercent(progress[<span class="number">0</span>]);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     protected <span class="type">void</span> onPostExecute(<span class="type">Long</span> <span class="literal">result</span>) &#123;</span><br><span class="line">         showDialog(<span class="string">"Downloaded "</span> + <span class="literal">result</span> + <span class="string">" bytes"</span>);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> //  执行一个<span class="type">Task</span></span><br><span class="line"> new <span class="type">DownloadFilesTask</span>().execute(url1, url2, url3);</span><br></pre></td></tr></table></figure></p>
<p>从这个实例中可以看出，<code>AsyncTask</code>把任务处理拆分为了几个过程(准备，执行，执行回馈，完成)，使用者只要在关注的过程里面写自己的逻辑就可以了，非常方便。官网的描述更加清晰：</p>
<blockquote>
<p>When an asynchronous task is executed, the task goes through 4 steps:</p>
<ol>
<li>onPreExecute(), invoked on the UI thread before the task is executed. This step is normally used to setup the task, for instance by showing a progress bar in the user interface.</li>
<li>doInBackground(Params…), invoked on the background thread immediately after<br>onPreExecute() finishes executing. This step is used to perform background computation that can take a long time. The parameters of the asynchronous task are passed to this step. The result of the computation must be returned by this step and will be passed back to the last step. This step can also use publishProgress(Progress…) to publish one or more units of progress. These values are published on the UI thread, in the onProgressUpdate(Progress…) step.</li>
<li>onProgressUpdate(Progress…), invoked on the UI thread after a call to publishProgress(Progress…). The timing of the execution is undefined. This method is used to display any form of progress in the user interface while the background computation is still executing. For instance, it can be used to animate a progress bar or show logs in a text field.</li>
<li>onPostExecute(Result), invoked on the UI thread after the background computation finishes. The result of the background computation is passed to this step as a parameter.</li>
</ol>
</blockquote>
<p>上面的描述翻译一下，对应到实际的执行过程就是这样的：</p>
<blockquote>
<p>AsyncTask执行过程一共有4步：</p>
<ol>
<li>onPreExecute()  对应到<strong>准备阶段</strong>。这个方法是用来做一些任务执行的准备工作，例如显示一个进度条之类的。</li>
<li>doInBackground(Params…) 对应到<strong>执行阶段</strong>。实际的业务逻辑（如网络连接，文件读写，复杂计算）就是放到这里做的，这个过程是和UI线程分离的，属于后台执行，所以叫做Background.</li>
<li>onProgressUpdate(Progress…),对应到<strong>执行回馈</strong>，这方法用于向UI线程汇报任务执行进度的，一般的操作就是会在更新精度条的显示百分比之类。</li>
<li>onPostExecute(Result) 对应到<strong>执行结束阶段</strong> ，这个一般是任务执行完毕后的一些后续操作，例如提示任务执行成功/失败，把进度条，模态框隐藏之类的。</li>
</ol>
</blockquote>
<p>针对AsynTask的这些特点，我们可以把这么一些点进行抽象，形成一个标准的玩法：</p>
<ol>
<li>进度条/模态框等<em>状态提示</em>性质的UI。</li>
<li>网络请求逻辑</li>
<li>任务执行完毕后的处理逻辑</li>
</ol>
<p>好了，废话不多说了，直接看现在我们的处理代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommAsyncTask</span> <span class="keyword">extends</span> <span class="title">AsyncTask</span>&lt;<span class="title">DBObject</span>, <span class="title">String</span>, <span class="title">DBObject</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String baseUrl = <span class="string">"http://192.168.1.101:8080/ms/"</span>;  <span class="comment">//服务端URL</span></span><br><span class="line">    <span class="keyword">private</span> Context context;</span><br><span class="line">    <span class="keyword">private</span> String action;  <span class="comment">// 服务端接口名</span></span><br><span class="line">    <span class="keyword">private</span> ProgressDialog pd;</span><br><span class="line">    <span class="keyword">private</span> OnCompleteListener listener;</span><br><span class="line">    <span class="keyword">private</span> String requestUrl;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> doHttp = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">private</span> DBObject errorResult = <span class="keyword">new</span> BasicDBObject();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String error_code_key = <span class="string">"____error"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">// 此接口用来定义任务执行完毕以后的处理逻辑</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OnCompleteListener</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">onPre</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(DBObject data)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onError</span><span class="params">(String msg)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onCancel</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CommAsyncTask</span><span class="params">(Context context, String action, OnCompleteListener listener)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.context = context;</span><br><span class="line">        <span class="keyword">this</span>.action = action;</span><br><span class="line">        <span class="keyword">this</span>.listener = listener;</span><br><span class="line">        <span class="keyword">this</span>.requestUrl = baseUrl + action;</span><br><span class="line">        <span class="keyword">this</span>.pd = <span class="keyword">new</span> ProgressDialog(context);</span><br><span class="line">        pd.setMessage(<span class="string">"提交中..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> DBObject <span class="title">doInBackground</span><span class="params">(DBObject... params)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!doHttp) &#123;</span><br><span class="line">            <span class="keyword">return</span> errorResult;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!isConnect(context)) &#123;</span><br><span class="line">            errorResult.put(error_code_key, <span class="string">"无法连接到网络"</span>);</span><br><span class="line">            <span class="keyword">return</span> errorResult;</span><br><span class="line">        &#125;</span><br><span class="line">        DBObject ret = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String retStr = HttpUtil.requestPostJSON(requestUrl, params[<span class="number">0</span>]);</span><br><span class="line">            ret = (DBObject) JSON.parse(retStr);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            errorResult.put(error_code_key, e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> errorResult;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPreExecute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (listener != <span class="keyword">null</span>) &#123;</span><br><span class="line">            doHttp = listener.onPre();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (pd != <span class="keyword">null</span>) &#123;</span><br><span class="line">            pd.show();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPostExecute</span><span class="params">(DBObject result)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (pd != <span class="keyword">null</span>) &#123;</span><br><span class="line">            pd.cancel();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (result != <span class="keyword">null</span> &amp;&amp; listener != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (result.containsField(error_code_key)) &#123;</span><br><span class="line">                listener.onError((String) result.get(error_code_key));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Integer status = (Integer) result.get(<span class="string">"status"</span>);</span><br><span class="line">                <span class="keyword">if</span> (status == <span class="number">0</span>) &#123;</span><br><span class="line">                    String info = (String) result.get(<span class="string">"info"</span>);</span><br><span class="line">                    listener.onError(info);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    listener.onSuccess(result);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCancelled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (listener != <span class="keyword">null</span>) &#123;</span><br><span class="line">            listener.onCancel();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isConnect</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获取手机所有连接管理对象（包括对wi-fi,net等连接的管理）</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ConnectivityManager connectivity = (ConnectivityManager) context.getSystemService(Context.CONNECTIVITY_SERVICE);</span><br><span class="line">            <span class="keyword">if</span> (connectivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 获取网络连接管理的对象</span></span><br><span class="line">                NetworkInfo info = connectivity.getActiveNetworkInfo();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (info != <span class="keyword">null</span> &amp;&amp; info.isConnected()) &#123;</span><br><span class="line">                    <span class="comment">// 判断当前网络是否已经连接</span></span><br><span class="line">                    <span class="keyword">if</span> (info.getState() == NetworkInfo.State.CONNECTED) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Log.v(<span class="string">"mcn"</span>, e.toString());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>实际使用就是这样的：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> CommAsyncTask(JsonActivity.<span class="keyword">this</span>, <span class="string">"my/post"</span>, <span class="keyword">new</span> CommAsyncTask.OnCompleteListener() &#123;</span><br><span class="line">                    <span class="annotation">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">onPre</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="annotation">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(DBObject data)</span> </span>&#123;</span><br><span class="line">                        String json = JSON.serialize(data);</span><br><span class="line">                        jtv1.setText(json);</span><br><span class="line">                        Toast.makeText(JsonActivity.<span class="keyword">this</span>, <span class="string">"success"</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="annotation">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onError</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">                        Toast.makeText(JsonActivity.<span class="keyword">this</span>, msg, Toast.LENGTH_SHORT).show();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="annotation">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onCancel</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;).execute(data);</span><br></pre></td></tr></table></figure></p>
<p>基本上只要访问的接口名/参数传入，然后在任务完成回调接口里面写一下任务完成的后续逻辑就可以了，整体使用下来还是非常方便的。</p>
<h3 id="Volley">Volley</h3><p><code>Volley</code>出现的比较晚，但是使用起来真的很优雅，在一些<em>简单场景</em>特别适合，官方提供了这么一些实现：</p>
<ul>
<li>StringRequest</li>
<li>JsonObjectRequest/JsonArrayRequest</li>
<li>ImageRequest</li>
<li>ImageLoader</li>
</ul>
<p>这里包含了针对String，Json,Image的网络请求，但是也仅限于这么一些场景，如果涉及到文件上传(byte []),它似乎无能为力，所以我特别强调了一下它只适用于一些<code>简单</code>场景。</p>
<p>好了，它的基本使用我就不再去累述了，直接看我们现在的通用实现模型吧：</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> class CommVolleyRequest extends Request&lt;DBObject&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Response.Listener&lt;DBObject&gt; listener;</span><br><span class="line">    <span class="keyword">private</span> Context context;</span><br><span class="line">    <span class="keyword">private</span> ProgressDialog pd;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; params;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; myHeaders;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> CommVolleyRequest(<span class="keyword">String</span> url, Context context, Response.Listener&lt;DBObject&gt; listener, Response.ErrorListener errorListener) &#123;</span><br><span class="line">        <span class="keyword">super</span>(Method.GET, url, errorListener);</span><br><span class="line">        <span class="keyword">this</span>.listener = listener;</span><br><span class="line">        <span class="keyword">this</span>.context = context;</span><br><span class="line">        initProgressDialog();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> initProgressDialog() &#123;</span><br><span class="line">        <span class="keyword">if</span> (context != <span class="keyword">null</span> &amp;&amp; pd == <span class="keyword">null</span>) &#123;</span><br><span class="line">            pd = <span class="keyword">new</span> ProgressDialog(context);</span><br><span class="line">            pd.setMessage(<span class="string">"正在提交..."</span>);</span><br><span class="line">            pd.show();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> CommVolleyRequest(<span class="built_in">int</span> method, <span class="keyword">String</span> url, Context context, Response.Listener&lt;DBObject&gt; listener, Response.ErrorListener errorListener) &#123;</span><br><span class="line">        <span class="keyword">super</span>(method, url, errorListener);</span><br><span class="line">        <span class="keyword">this</span>.listener = listener;</span><br><span class="line">        <span class="keyword">this</span>.context = context;</span><br><span class="line">        initProgressDialog();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">protected</span> Response parseNetworkResponse(NetworkResponse response) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">String</span> jsonString = <span class="keyword">new</span> <span class="keyword">String</span>(response.data, HttpHeaderParser.parseCharset(response.headers));</span><br><span class="line">            <span class="keyword">if</span> (pd != <span class="keyword">null</span>) &#123;</span><br><span class="line">                pd.dismiss();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> Response.success(JSON.parse(jsonString), HttpHeaderParser.parseCacheHeaders(response));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception je) &#123;</span><br><span class="line">            <span class="keyword">return</span> Response.error(<span class="keyword">new</span> ParseError(je));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> deliverResponse(DBObject o) &#123;</span><br><span class="line">        listener.onResponse(o);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 添加自定义Post参数</span><br><span class="line">     *</span><br><span class="line">     * @param p</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> setParams(Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; p) &#123;</span><br><span class="line">        <span class="keyword">this</span>.params = p;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 添加 header</span><br><span class="line">     * @param h</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> setMyHeaders(Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; h) &#123;</span><br><span class="line">        <span class="keyword">this</span>.myHeaders = h;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">protected</span> Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; getParams() <span class="keyword">throws</span> AuthFailureError &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.params;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; getHeaders() <span class="keyword">throws</span> AuthFailureError &#123;</span><br><span class="line">        Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; ret = <span class="keyword">new</span> <span class="keyword">HashMap</span>&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt;();</span><br><span class="line">        ret.putAll(<span class="keyword">super</span>.getHeaders());</span><br><span class="line">        <span class="keyword">if</span> (myHeaders != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ret.putAll(myHeaders);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用示例见下：<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">comm</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">       String url = <span class="string">"http://192.168.1.119:8080/my/my/post"</span>;</span><br><span class="line">       Response.Listener&lt;DBObject&gt; listener = <span class="keyword">new</span> Response.Listener&lt;DBObject&gt;() &#123;</span><br><span class="line">           @<span class="function">Override</span><br><span class="line">           <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span>(<span class="params">DBObject s</span>) </span>&#123;</span><br><span class="line">               Log.i(tag, s.toString());</span><br><span class="line">               Toast.makeText(NetActivity.<span class="keyword">this</span>, <span class="string">"success"</span>, Toast.LENGTH_SHORT).show();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;;</span><br><span class="line">       Response.ErrorListener errorListener = <span class="keyword">new</span> Response.ErrorListener() &#123;</span><br><span class="line"></span><br><span class="line">           @<span class="function">Override</span><br><span class="line">           <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onErrorResponse</span>(<span class="params">VolleyError volleyError</span>) </span>&#123;</span><br><span class="line">               Log.e(tag, <span class="string">"error"</span>);</span><br><span class="line">               Toast.makeText(NetActivity.<span class="keyword">this</span>, <span class="string">"error:"</span> + volleyError, Toast.LENGTH_SHORT).show();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;;</span><br><span class="line">       CommVolleyRequest request = <span class="keyword">new</span> CommVolleyRequest(url,NetActivity.<span class="keyword">this</span>,listener,errorListener);</span><br><span class="line">       <span class="comment">// 设置要传递的参数</span></span><br><span class="line">       HashMap <span class="keyword">params</span> = <span class="keyword">new</span> HashMap();</span><br><span class="line">       <span class="keyword">params</span>.put(<span class="string">"a"</span>,<span class="string">"abc"</span>);</span><br><span class="line">       request.setParams(<span class="keyword">params</span>);</span><br><span class="line">       <span class="comment">// 设置Header信息</span></span><br><span class="line">       HashMap headers = <span class="keyword">new</span> HashMap();</span><br><span class="line">       headers.put(<span class="string">"content-type"</span>,<span class="string">"application/json"</span>);</span><br><span class="line">       request.setMyHeaders(headers);</span><br><span class="line">       requestQueue.add(request);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>到这里就会发现<code>CommAsyncTask</code>和<code>Volley</code>的写法非常类似了，从通用的角度考虑，我们现在还是倾向于使用<code>CommAsyncTask</code>,当然，<code>Volley</code>其实特别适合于<code>图片下载</code>的处理，它和缓存机制结合的比较好，使用起来也比较优雅，值得尝试。</p>
  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/Android/">Android</a><a href="/tags/http/">http</a>
  </div>


<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Android/">Android</a>
</div>



<div class="article-share" id="share">

  <div data-url="http://yee.gitcafe.io/2014/08/12/Android异步网络通信解决方案的选择/" data-title="Android异步网络通信解决方案的选择 | 易叔好性感" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2014/08/15/Android中ViewPager实现引导页/" title="Android中ViewPager实现引导页">
  <strong>PREVIOUS:</strong><br/>
  <span>
  Android中ViewPager实现引导页</span>
</a>
</div>


<div class="next">
<a href="/2014/08/09/mongodb分片/"  title="mongodb分片">
 <strong>NEXT:</strong><br/> 
 <span>mongodb分片
</span>
</a>
</div>

</nav>

	
</div>  
      <div class="openaside"><a class="navbutton" href="#" title="顯示側邊欄"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目錄</strong>
  <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#AsyncTask"><span class="toc-number">1.</span> <span class="toc-text">AsyncTask</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Volley"><span class="toc-number">2.</span> <span class="toc-text">Volley</span></a></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隱藏側邊欄"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分類</p>
		<ul>
		
			<li><a href="/categories/Android/" title="Android">Android<sup>8</sup></a></li>
		
			<li><a href="/categories/DB/" title="DB">DB<sup>7</sup></a></li>
		
			<li><a href="/categories/design-pattern/" title="design-pattern">design-pattern<sup>1</sup></a></li>
		
			<li><a href="/categories/java-core/" title="java-core">java-core<sup>9</sup></a></li>
		
			<li><a href="/categories/工具/" title="工具">工具<sup>1</sup></a></li>
		
			<li><a href="/categories/生活/" title="生活">生活<sup>1</sup></a></li>
		
			<li><a href="/categories/读书/" title="读书">读书<sup>1</sup></a></li>
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">標簽</p>
		<ul class="clearfix">
		
			<li><a href="/tags/Android/" title="Android">Android<sup>8</sup></a></li>
		
			<li><a href="/tags/MongoDB/" title="MongoDB">MongoDB<sup>1</sup></a></li>
		
			<li><a href="/tags/NIO/" title="NIO">NIO<sup>1</sup></a></li>
		
			<li><a href="/tags/Servlet3/" title="Servlet3">Servlet3<sup>1</sup></a></li>
		
			<li><a href="/tags/UI/" title="UI">UI<sup>6</sup></a></li>
		
			<li><a href="/tags/design-pattern/" title="design-pattern">design-pattern<sup>1</sup></a></li>
		
			<li><a href="/tags/github/" title="github">github<sup>1</sup></a></li>
		
			<li><a href="/tags/gradle/" title="gradle">gradle<sup>1</sup></a></li>
		
			<li><a href="/tags/hexo/" title="hexo">hexo<sup>1</sup></a></li>
		
			<li><a href="/tags/http/" title="http">http<sup>2</sup></a></li>
		
			<li><a href="/tags/java/" title="java">java<sup>7</sup></a></li>
		
			<li><a href="/tags/java-core/" title="java-core">java-core<sup>2</sup></a></li>
		
			<li><a href="/tags/jvm/" title="jvm">jvm<sup>1</sup></a></li>
		
			<li><a href="/tags/linux/" title="linux">linux<sup>1</sup></a></li>
		
			<li><a href="/tags/mongodb/" title="mongodb">mongodb<sup>4</sup></a></li>
		
			<li><a href="/tags/mysql/" title="mysql">mysql<sup>1</sup></a></li>
		
			<li><a href="/tags/netty/" title="netty">netty<sup>1</sup></a></li>
		
			<li><a href="/tags/nio/" title="nio">nio<sup>1</sup></a></li>
		
			<li><a href="/tags/nosql/" title="nosql">nosql<sup>1</sup></a></li>
		
			<li><a href="/tags/shell/" title="shell">shell<sup>1</sup></a></li>
		
		</ul>
</div>


  <div class="rsspart">
	<a href="null" target="_blank" title="rss">RSS 訂閱</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<div class="social-font clearfix">
		
		
		
		
		
	</div>
		<p class="copyright">Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/A-limon/pacman" target="_blank" title="Pacman">Pacman</a> © 2016 
		
		<a href="http://yee.gitcafe.io" target="_blank" title="yee">yee</a>
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>






  </body>
</html>
